# RealtyChatBot
Чатбот для оформления объявлений по шаблону с последующей их публикацией в тематическом Телеграм-канале.

## Основные функции
1. Создание объявления по шаблону, заданному в коде бота.
2. Редактирование заполненного объявления перед его отправкой в тематический чат.
3. Отправка объявления в тематический чат и сохранение его в базе данных на сервере, на котором запущен бот.
4. Обновление ранее отправленного объявления.

## Описание структуры объявления
Объявление, отправляемое в тематический чат, состоит из нескольких отдельных сообщений следующего содержания:
1. Заголовок с указанием номера объявления (всегда).
2. Основная текстовая часть из нескольких строк (всегда).
3. Дополнительные сообщения с текстом, фотографиями, аудио-видео-файлами, документами или геопозицией. Эти сообщения необязательны и будут присутствовать, если пользователь отправил перечисленную информациию при создании или редактировании объявления. 

## Порядок использования
При самом первом обращении к боту необходимо вручную набрать и отправить команду  */start*. В ответ на нее бот отправляет пользователю приветственное сообщение и клавиатуру с основными командами. (На десктопной версии Telegram эта клавиатуру имеет свойство сворачиваться в процессе использования бота). В дальнейшем использование функций бота осуществляется при помощи команд, которые будут отображаются на клавиатуре, созданной ботом (эти команды можно также ввести вручную), и при помощи отправляемых ботом кнопок.

### Основные команды
1. `/create` или `/Создать_объявление` - запускает диалог для заполнения бланка объявления;
2. `/renew` или `/Обновить_объявление`- запускает процесс для поиска и редактирования ранее созданного объявления;
3. `/Прекратить` - останавливает текущий процесс создания или редактирования;
4. `/break` или `/Завершить_все` - останавливает все запущенные пользователем процессы (стек команд полностью очищается);
5. `/help` или `/Подсказка` - выводит информацию о работе с ботом.

При вводе команд вручную важно соблюдать регистр первого символа и не пропускать знак подчеркивания "_" там, где он есть.

###  Описание процесса создания объявления
1. Запустить процесс ручным вводом команды `/create` или нажатием на кнопку с названием команды `/Создать_объявление`.
2. Отправить запрашиваемую информацию в процессе диалога с ботом. В текущей реализации на каждом шаге выполняется проверка допустимости отправленных данных. Например, если ожидается ввод текста, то в ответ на направленную фотографию бот укажет на ошибку типа данных. Если вместо числа для конкретного пункта объявления будет направлен текст, бот также сообщит об этом.
3. Если на каком-то шаге ввод информации не является обязательным, бот пришлет кнопку "Пропустить" для возможности пропуска ввода данных.
4. Когда все предусмотренные диалогом вопросы будут заданы, бот пришлет макет объявления и две кнопки для выбора действия: "Разместить" и "Редактировать". 
При выборе кнопки "Разместить" объявление будет направлено в тематический чат и сохранено в базе данных, а пользователю вернется сообщение с номером объявления, кодом на случай возникновения необходимости в редактировании объявления и кнопкой для запуска редактирования данного объявления ("Обновить_объявление"). 
При выборе кнопки "Редактировать" запустится процесс редактирования текущего объявления. Он описан далее.
5. В течение всего процесса на клавиатуре бота присутствует только команда `/Прекратить`, с помощью которой можно остановить создание объявления.

###  Описание процесса редактирования объявления
1. Запустить процесс одним из способов:
- вручную ввести команду `/renew` или нажать на кнопку с названием команды `/Обновить_объявление`, а затем ввести код для доступа к редактированию, который был получен при создании объявления;
- нажать на кнопку, которая была создана в конце процесса создания объявления.
2. Редактировать объявления может автор объявления, а также другой пользователь, которому даны права модератора или админа. В текущей версии бота не реализован интерфейс для назначения пользователям этих прав, но это можно выполнить путем ручного внесения информации в базу данных (таблица БД 'tg_users', в поле 'is_admin', 'is_moderator' записать значение True).
3. После запуска процесса бот в ответном сообщении пришлет набор кнопок, соответствующих пунктам объявления. Кнопки для пунктов, которые относятся к основной части объявления (см. описание структуры объявления), будут проименованы в соответствии с названием этих пунктов. Кнопки для дополнительных пунктов объявления будут проименованы условно: наименование типа содержимого плюс временно присвоенный порядковый номер.
4. Для редактирования пункта нужно нажать на соответствующую ему кнопку. Бот в ответном сообщении пришлет текущее сохраненное значение пункта и попросит отправить новое значение.
5. Пункты, предназначенные для дополнительной информации, могут быть дополнены новыми сообщениями (фото, аудио, видео, документами или геопозицией). При выборе такого пункта бот сообщит о возможности его дополнения. Также из такого пункта могут быть удалены ранее сохраненные сообщения при помощи команды `/Удалить` на клавиатуре бота.
6. Для сохранения изменений и завершения редактирования нужно отправить команду `/Применить` - она есть на клавиатуре бота.
7. Для завершения процесса без сохранения изменений применяется команда `/Прекратить`.
8. При сохранении изменений реализована следующая логика, обусловленная функционалом API Telegram:
- если в отредактированном объявлении количество дополнительных сообщений (см. описание структуры объявления) одного типа такое же или меньше, чем было в исходном варианте, то выполняется изменение сообщений, которые ранее отправлялись в Телеграм;
- если дополнительных сообщений стало больше, то объявление отправляется вновь; при этом номер объявления сохраняется, а код для доступа к редактированию выдается новый.

###  Удаление сообщения
В текущей версии бота нет функции полного удаления объявления. Функционал позволяет удалить только одно или все дополнительные сообщения объявления.


## Развертывание и настройка бота
### Подготовительный этап
1. Необходимо получить токен для бота, при помощи которого он будет проходить авторизацию в Телеграм. Для этого в мессенджере Телеграм нужно найти бота `@BotFather`, запустить диалог с ним командой `/start`, а затем отправить ему команду `/newbot` и следовать полученным инструкциям. В конце процесса бот пришлет необходимый токен.
2. Также нужно получить идентификатор тематического чата (группы) и темы внутри это чата (если создана), в который будут отправляться объявления. Их можно вычленить из ссылки на группу (тему группы). Ссылка на тему доступна через меню "Информация о теме" (при нахождении в этой теме) и имеет вид:\
*https://t.me/c/17хххх2340/1*. Здесь `1` - это идентификатор темы, а 17хххх2340 - идентификатор группы. Для использования ботом к идентификатору группы нужно добавить префикс `-100`, чтобы получилвсь строка вида *-10017хххх2340*.

### Развертывание бота
1. На компьютере должен быть установлен Python 3.6 или выше и Git.
2. Создать папку для размещения кода бота, открыть ее в командной строке и выполнить копирование репозитория бота
 `git clone https://github.com/korey-h/RealtyChatBot/tree/dev`
3. Создать в той же папке файл `.env` (иное имя потребует внесения изменений в код бота в файле *bot.py*).
4. В созданный файл внести следующие записи (значения параметров даны для примера):\
 `TOKEN = '1xxxxxxxxx:fxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxA'`\
 `DEVELOP_ID = '1ххххххх7'`\
 `CHAT_ID = '-10017хххх2340'`\
 `MESSAGE_THREAD_ID = '1'`\
 `DB_NAME = 'mess_db.db'`\
 `DB_PATH = ''`

 Назначение параметров:
  `TOKEN` - токен, полученный от @BotFather;\
 `DEVELOP_ID` - id пользователя Телеграм, которому будут отправляться сообщения об ошибках в работе бота;\
 `CHAT_ID` - идентификатор группы, в которую будут отправляться объявления;\
 `MESSAGE_THREAD_ID` - номер темы в группе;\
 `DB_NAME` - имя файла базы данных;\
 `DB_PATH` - путь к директории с файлом базы данных; если файл будет располагаться в папке с кодом бота, значение остаить ''.

 Примечание: в текущей реализации бот работает с БД sqlite.

5. Создать в той же папке виртуальное окружение для бота командой\
 `python -m venv venv`. 

 Активировать виртуальное окружение:\
 `source ./venv/Scripts/activate` - при запуске под Windows,\
 `source ./venv/bin/activate` - при запуске под Linux.

 Запустить установку необходимых пакетов, перечисленных в файле *requirements.txt*:\
 `pip install -r requirements.txt`

7. Настроить инструмент для выполнения миграций в БД.\
 Выполнить команду для создания набора папок и файлов конфигурации инструмента:\
 `alembic  init`\
 В файле alembic.ini (расположен в папке с кодом бота) присвоить значения следующим параметрам:\
 `sqlalchemy.url = sqlite:///mess_db.db`\
 *mess_db.db* - это имя файла БД, должно быть таким же, как в пункте 5.\
 В файле *env.py*, расположенном в папке *alembic* должны быть следующие записи:\
 `from db_models import Base`

 `target_metadata = Base.metadata`

 Примечание: *db_models* - это файл бота, содержащий модели таблиц БД.

 В этом же файле в двух местах найти метод *context.configure* и добавить ему параметр *render_as_batch=True*. В результате получится запись:\
 `context.configure(`\
     `connection=connection, target_metadata=target_metadata,`\
     `render_as_batch=True)`

8. Создать и применить миграции:\
 `alembic  revision –m “initial” --autogenerate`\
 `alembic upgrade head`

9. На этом шаге можно запустить бота командой `python bot.py`


### Настройка диалога
1. Основная часть текстов диалога и названий кнопок находится в файле `config.py`.
2. Для изменения состава пунктов объявления (добавления или удаления) необходимо внести изменения сразу в несколько переменных. Атрибуты класса `RegistrProces`, требующие корректировки, вынесены в отдельный файл *blank_config.py*. В том же файле находятся блоки кода, выполняющего проверку взаимосвязей между описанными ниже переменными. В случае ошибок в заимосвязях при запуске бота будет выброшено исключение с описанием ошибки.

#### `RegistrProces.adv_blank`
Изменение обязательно. Содержит названия всех пунктов объявления и косвенно определяет состав принимаемых данных. Пример содержания:\
`.adv_blank = {'space': None,`\
`             'material': '',`\
`             'photo': [],}`

Если елемент словаря определен как список, то этот пункт априо относится к дополнительной части объявления. Во время диалога с ботом в этот пункт можно будет записать несколько сообщений пользователя (многозначный пункт). В примере выше это пункт `'photo'`. В остальных вариантах типа элемента один пункт будет принимать только одно сообщение пользователя (однозначный пункт).

#### `RegistrProces.title_mess_content`
Изменение обязательно. Содержит имена однозначных пунктов, которые будут включены в основной текстовый блок объявления. Пример:\
`.title_mess_content = ['space', 'material']`\
Имена в этой переменной должны обязательно совпадать с именами ключей в `.adv_blank`.

#### `RegistrProces._step_actions`
Изменение обязательно. Содержит связь между номером шага диалога с ботом и именем пункта бланка объявления, а также определяет возможность пропуска ввода ответа на вопрос бота. Пример:\
`._step_actions = {`\
`        0: {'name': None, 'required': True},`\
`        1: {'name': 'space', 'required': True},`\
`        2: {'name': 'material', 'required': True},`\
`        3: {'name': 'photo', 'required': False},`\
`        4: {'name': None, 'required': True},`\
`        5: {'name': None, 'required': True},}`\
Первый, последний и предпоследний элементы этого словаря нельзя изменять, они (в примере это ключи 0, 4 и 5) необходимы для алгоритма бота. Если значение ключа `'required'` установлено в False, то на этом пункте диалога бот пришлёт кнопку "Пропустить" и ответ на запрос бота можно будет пропустить при необходимости.
Значения ключей 'name' обязательно должны присутствовать в переменной `.adv_blank` (кроме первого, последнего и предпоследнего).

#### `RegistrProces._base_messages`
Изменение обязательно. Содержит тексты запросов, которые бот направляет в процессе диалога.
Количество элементов и имена ключей должны совпадать со значениями в переменной `._step_actions`. Тип значения каждого ключа - список словарей. Пример:\
`._base_messages = {`\
`     0: welcome_mess,`\
 `    1: [{'text': ADV_MESSAGE['mess_ask_space']}],`\
 `    2: [{'text': ADV_MESSAGE['mess_ask_material']}],`\
 `    3: [{'text': ttg.text_add_foto,`\
 `        'kbd_maker': sb.farther_keyboard}],`\
 `    4: [{'text': ADV_MESSAGE['mess_confirm_adv'],`\
 `            'kbd_maker': sb.cancel_this_kbd},`\
 `            {'text': adv_former, 'kbd_maker': sb.send_btn}],`\
 `    5: [{'text': _stop_text}],`\
 `    }`

Первый, последний и предпоследний элементы этого словаря нельзя изменять, они (в примере это ключи 0, 4 и 5) необходимы для алгоритма бота. Здесь тексты находятся в словаре *ADV_MESSAGE* из файла `config.py`.

#### `ADV_BLANK_WORDS` в `congif.py`
Изменение обязательно. Содержит названия полей бланка объявления, которые будут отображаться в объявлении. Пример:\
`ADV_BLANK_WORDS = {`\
`    'space': 'Площадь, кв.м (с учётом балконов)',`\
`    'material': 'Материал дома',`\
`    'photo': 'Фотографии и прочее описание:',`\
`    'title': 'Объявление № __.'}` 

Имя ключа 'title' удалять или переименовывать нельзя.

#### `TitleMessages` в `db_models.py`
Внесение изменений в состав атрибутов класса `TitleMessages` обязательно, если меняются значения в `RegistrProces.title_mess_content`!
Имена ключей в `RegistrProces.adv_blank` соответствуют атрибутам в `TitleMessages`. Пример указания добавляемого атрибута *contact* (остальные не показаны):\
`class TitleMessages(Base):`\
`    contact: Mapped[str] = mapped_column(String(), nullable=True)`

После изменения `TitleMessages` обязательно нужно создать миграцию и применить ее к БД.\
Вначале нужно узнать номер ревизии данных в БД с помощью команды:\
`alembic current`

Затем создать миграцию:\
`alembic  revision –m “комментарий” --autogenerate --head номер_ревизии`

И применить миграцию:
`alembic  upgrade head`

3. Перечисленные далее переменные необязательно корректировать при добавлении нового пункта в бланк объявления, но корректировка потребуется при удалении пункта из бланка.

#### `RegistrProces.validators`
Содержит перечисление валидаторов для проверки поступивших от пользователя данных. В текущей реализации для одного пункта объявления (шага диалога с ботом) назначается только один валидатор. Если валидатор не назначен, то данные принимаются без проверки. Пример:\
`validators = {`\
`            1: vlds.to_integer,`\
`            2: vlds.to_integer,}`

В примере 1 и 2 - это номера шагов диалога. Они должны соответствовать ключам в переменной `RegistrProces._step_actions`.
Валидаторы собраны в файле `validators.py`. Валидатор возвращает словарь с двумя ключами:\
 *'data'* содержит исходные данные,\
 *'error'* *содержит текст сообщения об ошибке (если данные не прошли проверку) или None (если ошибок не было).

#### `RegistrProces._step_exp_types`
Содержит для каждого шага указание типа сообщения Телеграм, которое будет принято к обработке. Вот типы сообщений, на обработку которых настроен бот: *'text'*, *'audio'*, *'photo'*, *'document'*, *'video'*, *'location'*. Если на шаге диалога пользователь отправит сообщение, тип которого не обрабатывается на этом шаге, бот сообщит об этом и перечислит поддерживаемые типы. Пример:\
`._step_exp_types = {`\
`            1: ('text',),`\
`            2: ('text',),`\
`            3: ( 'photo', 'video'),}`