# RealtyChatBot
Чатбот для оформления объявлений по шаблону с последующей их публикацией в тематическом Телеграм-канале.

## Основные функции
1. Создание объявления по шаблону, заданному в коде бота.
2. Редактирование заполненного объявления перед его отправкой в тематический чат.
3. Отправка объявления в тематический чат и сохранение его в базе данных на сервере, на котором запущен бот.
4. Обновление ранее отправленного объявления.

## Описание структуры объявления
Объявление, отправляемое в тематический чат, состоит из нескольких отдельных сообщений следующего содержания:
1. Заголовок с указанием номера объявления (всегда).
2. Основная текстовая часть из нескольких строк (всегда).
3. Дополнительные сообщения с текстом, фотографиями, аудио-видео-файлами, документами или геопозицией. Эти сообщения необязательны и будут присутствовать, если пользователь отправил перечисленную информациию при создании или редактировании объявления. 

## Порядок использования
При самом первом обращении к боту необходимо вручную набрать и отправить команду  */start*. В ответ на нее бот отправляет пользователю приветственное сообщение и клавиатуру с основными командами. (На десктопной версии Telegram эта клавиатуру имеет свойство сворачиваться в процессе использования бота). В дальнейшем использование функций бота осуществляется при помощи команд, которые будут отображаются на клавиатуре, созданной ботом (эти команды можно также ввести вручную), и при помощи отправляемых ботом кнопок.

### Основные команды
1. `/create` или `/Создать_объявление` - запускает диалог для заполнения бланка объявления;
2. `/renew` или `/Обновить_объявление`- запускает процесс для поиска и редактирования ранее созданного объявления;
3. `/Прекратить` - останавливает текущий процесс создания или редактирования;
4. `/break` или `/Завершить_все` - останавливает все запущенные пользователем процессы (стек команд полностью очищается);
5. `/help` или `/Подсказка` - выводит информацию о работе с ботом.

При вводе команд вручную важно соблюдать регистр первого символа и не пропускать знак подчеркивания "_" там, где он есть.

###  Описание процесса создания объявления
1. Запустить процесс ручным вводом команды `/create` или нажатием на кнопку с названием команды `/Создать_объявление`.
2. Отправить запрашиваемую информацию в процессе диалога с ботом. В текущей реализации на каждом шаге выполняется проверка допустимости отправленных данных. Например, если ожидается ввод текста, то в ответ на направленную фотографию бот укажет на ошибку типа данных. Если вместо числа для конкретного пункта объявления будет направлен текст, бот также сообщит об этом.
3. Если на каком-то шаге ввод информации не является обязательным, бот пришлет кнопку "Пропустить" для возможности пропуска ввода данных.
4. Когда все предусмотренные диалогом вопросы будут заданы, бот пришлет макет объявления и две кнопки для выбора действия: "Разместить" и "Редактировать". 
При выборе кнопки "Разместить" объявление будет направлено в тематический чат и сохранено в базе данных, а пользователю вернется сообщение с номером объявления, кодом на случай возникновения необходимости в редактировании объявления и кнопкой для запуска редактирования данного объявления ("Обновить_объявление"). 
При выборе кнопки "Редактировать" запустится процесс редактирования текущего объявления. Он описан далее.
5. В течение всего процесса на клавиатуре бота присутствует только команда `/Прекратить`, с помощью которой можно остановить создание объявления.

###  Описание процесса редактирования объявления
1. Запустить процесс одним из способов:
- вручную ввести команду `/renew` или нажать на кнопку с названием команды `/Обновить_объявление`, а затем ввести код для доступа к редактированию, который был получен при создании объявления;
- нажать на кнопку, которая была создана в конце процесса создания объявления.
2. Редактировать объявления может автор объявления, а также другой пользователь, которому даны права модератора или админа. В текущей версии бота не реализован интерфейс для назначения пользователям этих прав, но это можно выполнить путем ручного внесения информации в базу данных (таблица БД 'tg_users', в поле 'is_admin', 'is_moderator' записать значение True).
3. После запуска процесса бот в ответном сообщении пришлет набор кнопок, соответствующих пунктам объявления. Кнопки для пунктов, которые относятся к основной части объявления (см. описание структуры объявления), будут проименованы в соответствии с названием этих пунктов. Кнопки для дополнительных пунктов объявления будут проименованы условно: наименование типа содержимого плюс временно присвоенный порядковый номер.
4. Для редактирования пункта нужно нажать на соответствующую ему кнопку. Бот в ответном сообщении пришлет текущее сохраненное значение пункта и попросит отправить новое значение.
5. Пункты, предназначенные для дополнительной информации, могут быть дополнены новыми сообщениями (фото, аудио, видео, документами или геопозицией). При выборе такого пункта бот сообщит о возможности его дополнения. Также из такого пункта могут быть удалены ранее сохраненные сообщения при помощи команды `/Удалить` на клавиатуре бота.
6. Для сохранения изменений и завершения редактирования нужно отправить команду `/Применить` - она есть на клавиатуре бота.
7. Для завершения процесса без сохранения изменений применяется команда `/Прекратить`.
8. При сохранении изменений реализована следующая логика, обусловленная функционалом API Telegram:
- если в отредактированном объявлении количество дополнительных сообщений (см. описание структуры объявления) одного типа такое же или меньше, чем было в исходном варианте, то выполняется изменение сообщений, которые ранее отправлялись в Телеграм;
- если дополнительных сообщений стало больше, то объявление отправляется вновь; при этом номер объявления сохраняется, а код для доступа к редактированию выдается новый.

###  Удаление сообщения
В текущей версии бота нет функции полного удаления объяаления. Функционал позваляет удалить только одно или все дополнительные сообщения объявления.


## Развертывание и настройка бота
### Подготовительный этап
1. Необходимо получить токен для бота, при помощи которого он будет проходить авторизацию в Телеграм. Для этого в мессенджере Телеграм нужно найти бота `@BotFather`, запустить диалог с ним командой `/start`, а затем отправить ему команду `/newbot` и следовать инструкциям от бота. В конце процесса будет получен необходимый токен.
2. Также нужно получить идентификатор тематического чата (группы) и темы внутри это чата (если создана), в который будут отправляться объявления. Их можно вычленить из ссылки на группу (тему группы). Ссылка на тему доступна через меню "Информация о теме" (при нахождении в этой теме) и имеет вид:
*https://t.me/c/17хххх2340/2*. Здесь `2` - это идентификатор темы, а 17хххх2340 - идентификатор группы. Для использования ботом к идентификатору группы нужно добавить префикс `-100`, чтобы получилвсь строка вида *-10017хххх2340*.
